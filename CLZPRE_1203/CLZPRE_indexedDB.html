<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aut√≥-Tulajdonos Adatb√°zis (IndexedDB CRUD + 1:N)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }

        h1, h2 {
            color: #333;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
        }

        section {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .form-group label {
            width: 120px;
            font-weight: bold;
        }

        .form-group input[type="text"],
        .form-group select {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }
        
        .delete-btn {
            background-color: #dc3545;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .edit-btn {
            background-color: #ffc107;
            color: #333;
        }
        .edit-btn:hover {
            background-color: #e0a800;
        }

        /* T√°bl√°zat st√≠lusok */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        table th {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }

        .muvelet-cella {
            width: 150px;
        }
        
        /* JSON M≈±veletek */
        #json-adat {
            width: 100%;
            height: 150px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            resize: vertical;
        }
    </style>
</head>
<body>

    <h1>üöó IndexedDB Adatb√°zis Kezel√©s (CLZPRE)</h1>

    <section id="tulajdonos-crud">
        <h2>üßë‚Äçüíº Tulajdonos Kezel√©s</h2>
        <form id="tulajdonos-form">
            <input type="hidden" id="tulaj-tkod-modositando" value="">
            <div class="form-group">
                <label for="tulaj-nev">N√©v:</label>
                <input type="text" id="tulaj-nev" required>
            </div>
            <div class="form-group">
                <label for="tulaj-email">Email:</label>
                <input type="text" id="tulaj-email" required>
            </div>
            <button type="submit" id="tulaj-mentes-btn">üíæ √öj Tulajdonos Ment√©se</button>
            <button type="button" onclick="tulajFormReset()">üóëÔ∏è ≈∞rlap T√∂rl√©se</button>
        </form>

        <hr>

        <h3>Keres√©s Tulajdonosok k√∂z√∂tt</h3>
        <div class="form-group">
            <label for="tulaj-kereses-nev">Keres√©s (N√©v):</label>
            <input type="text" id="tulaj-kereses-nev" onkeyup="tulajdonosokListazasa()">
        </div>

        <h3>√ñsszes Tulajdonos</h3>
        <table id="tulajdonos-tabla">
            <thead>
                <tr>
                    <th>T.K√≥d</th>
                    <th onclick="tulajdonosokListazasa('nev')">N√©v ‚ÜïÔ∏è</th>
                    <th>Email</th>
                    <th class="muvelet-cella">M≈±veletek</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <hr>
    
    <section id="auto-crud">
        <h2>üõ†Ô∏è Aut√≥ Kezel√©s</h2>
        <form id="auto-form">
            <input type="hidden" id="auto-eredeti-rendszam" value="">
            
            <div class="form-group">
                <label for="auto-rendszam">Rendsz√°m (F≈ë kulcs):</label>
                <input type="text" id="auto-rendszam" required minlength="6" maxlength="7" pattern="[A-Z0-9]+" title="6-7 karakter, csak bet≈±/sz√°m">
            </div>
            <div class="form-group">
                <label for="auto-tulajTkod">Tulajdonos (1:N):</label>
                <select id="auto-tulajTkod" required>
                    <option value="">-- V√°lasszon Tulajdonost --</option>
                    </select>
            </div>
            <div class="form-group">
                <label for="auto-tipus">T√≠pus:</label>
                <input type="text" id="auto-tipus" required>
            </div>
            <div class="form-group">
                <label for="auto-szin">Sz√≠n:</label>
                <input type="text" id="auto-szin" required>
            </div>
            <div class="form-group">
                <label for="auto-evjarat">√âvj√°rat:</label>
                <input type="number" id="auto-evjarat" min="1900" max="2100" required>
            </div>
            
            <button type="submit" id="auto-mentes-btn">üíæ √öj Aut√≥ Ment√©se</button>
            <button type="button" onclick="autoFormReset()">üóëÔ∏è ≈∞rlap T√∂rl√©se</button>
        </form>

        <hr>

        <h3>Keres√©s / Sz≈±r√©s</h3>
        <div class="form-group">
            <label for="auto-kereses">Keres√©s (Rendsz√°m, T√≠pus, Sz√≠n):</label>
            <input type="text" id="auto-kereses" onkeyup="autokListazasa()">
        </div>
        <div class="form-group">
            <label for="auto-szures-tulaj">Sz≈±r√©s (Tulajdonos):</label>
            <select id="auto-szures-tulaj" onchange="autokListazasa()">
                <option value="">-- √ñsszes Tulajdonos --</option>
                </select>
        </div>

        <h3>Aut√≥k List√°ja</h3>
        <table id="auto-tabla">
            <thead>
                <tr>
                    <th onclick="autokListazasa('rendszam')">Rendsz√°m ‚ÜïÔ∏è</th>
                    <th onclick="autokListazasa('tipus')">T√≠pus ‚ÜïÔ∏è</th>
                    <th onclick="autokListazasa('szin')">Sz√≠n ‚ÜïÔ∏è</th>
                    <th>√âvj√°rat</th>
                    <th>Tulajdonos (T.K√≥d)</th>
                    <th class="muvelet-cella">M≈±veletek</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <hr>

    <section id="json-muveletek">
        <h2>üîÑ JSON Export / Import</h2>
        <textarea id="json-adat" placeholder="Illessze be ide a JSON adatot az import√°l√°shoz..."></textarea><br>
        <button onclick="exportDB()">‚¨áÔ∏è Export DB (JSON)</button>
        <button onclick="importDB()">‚¨ÜÔ∏è Import DB (JSON)</button>
    </section>

    <script>
        // IndexedDB Konstansok
        const DB_NAME = 'AutoTulajDB_v1';
        const DB_VERSION = 1;
        const STORE_TULAJDONOS = 'Tulajdonos';
        const STORE_AUTO = 'Auto';
        let db; // Az adatb√°zis objektumot t√°rolja

        // Rendez√©s √°llapota
        let tulajRendezesOszlop = 'tkod';
        let autoRendezesOszlop = 'rendszam';
        let rendezesIrany = 'asc'; // Glob√°lis rendez√©si ir√°ny

        // 1. **IndexedDB Inicializ√°l√°s √©s Strukt√∫ra Be√°ll√≠t√°sa**

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error("IndexedDB hiba:", event.target.errorCode);
                    alert("Hiba az adatb√°zis megnyit√°sakor: " + event.target.errorCode);
                    reject(event.target.errorCode);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("IndexedDB sikeresen megnyitva.");
                    
                    // Friss√≠tj√ºk a Tulajdonos dropdown list√°kat
                    tulajdonosokFeltolteseDropdownnal();
                    // List√°k inicializ√°l√°sa
                    tulajdonosokListazasa();
                    autokListazasa();
                    resolve(db);
                };

                // A strukt√∫ra be√°ll√≠t√°sa/friss√≠t√©se (csak verzi√≥v√°lt√°skor fut le)
                request.onupgradeneeded = (event) => {
                    db = event.target.result;

                    // Tulajdonos Object Store
                    if (!db.objectStoreNames.contains(STORE_TULAJDONOS)) {
                        const tulajdonosStore = db.createObjectStore(STORE_TULAJDONOS, { keyPath: 'tkod', autoIncrement: true });
                        tulajdonosStore.createIndex('nev', 'nev', { unique: false });
                        console.log(`${STORE_TULAJDONOS} object store l√©trehozva.`);
                    }

                    // Aut√≥ Object Store
                    if (!db.objectStoreNames.contains(STORE_AUTO)) {
                        const autoStore = db.createObjectStore(STORE_AUTO, { keyPath: 'rendszam' });
                        autoStore.createIndex('tulajTkod', 'tulajTkod', { unique: false });
                        autoStore.createIndex('tipus', 'tipus', { unique: false });
                        autoStore.createIndex('szin', 'szin', { unique: false });
                        console.log(`${STORE_AUTO} object store l√©trehozva.`);
                        
                        // Adatok felt√∂lt√©se (min rekord)
                        event.target.transaction.oncomplete = () => {
                            feltoltMintaAdatok();
                        };
                    }
                };
            });
        }
        
        // Minta adatok bet√∂lt√©se az els≈ë futtat√°skor
        function feltoltMintaAdatok() {
            const tx = db.transaction([STORE_TULAJDONOS, STORE_AUTO], 'readwrite');
            const tulajdonosStore = tx.objectStore(STORE_TULAJDONOS);
            const autoStore = tx.objectStore(STORE_AUTO);
            
            // 1. Tulajdonosok
            const tulaj1 = { nev: 'Kiss B√©la', email: 'kiss.bela@email.hu' };
            const tulaj2 = { nev: 'Nagy Anna', email: 'nagy.anna@email.hu' };
            const tulaj3 = { nev: 'Varga Tam√°s', email: 'varga.tamas@email.hu' };

            const req1 = tulajdonosStore.add(tulaj1);
            req1.onsuccess = (e) => {
                const tkod1 = e.target.result; // Megkapjuk az autoIncrement kulcsot
                // 2. Aut√≥k hozz√°ad√°sa a Tulajdonos 1-hez
                autoStore.add({ rendszam: 'ABC-123', tulajTkod: tkod1, tipus: 'Suzuki Swift', szin: 'Piros', evjarat: 2005 });
                autoStore.add({ rendszam: 'XYZ-987', tulajTkod: tkod1, tipus: 'Toyota Yaris', szin: 'K√©k', evjarat: 2018 });
            };

            const req2 = tulajdonosStore.add(tulaj2);
            req2.onsuccess = (e) => {
                const tkod2 = e.target.result;
                autoStore.add({ rendszam: 'DEF-456', tulajTkod: tkod2, tipus: 'Ford Focus', szin: 'Fekete', evjarat: 2010 });
            };

            tulajdonosStore.add(tulaj3); // tkod3 autoIncrement

            tx.oncomplete = () => {
                console.log("Minta adatok felt√∂ltve.");
                tulajdonosokFeltolteseDropdownnal();
                tulajdonosokListazasa();
                autokListazasa();
            };
            tx.onerror = (e) => console.error("Minta adatok felt√∂lt√©si hiba:", e);
        }

        // 2. **Tulajdonos CRUD √©s Keres√©s**
        
        document.getElementById('tulajdonos-form').onsubmit = (event) => {
            event.preventDefault();
            const tkod = document.getElementById('tulaj-tkod-modositando').value;
            const nev = document.getElementById('tulaj-nev').value.trim();
            const email = document.getElementById('tulaj-email').value.trim();
            
            const tulaj = { nev, email };
            if (tkod) {
                tulaj.tkod = parseInt(tkod); // M√≥dos√≠t√°shoz be kell √°ll√≠tani a kulcsot
            }

            mentesTulajdonos(tulaj);
        };

        function mentesTulajdonos(tulaj) {
            const tx = db.transaction(STORE_TULAJDONOS, 'readwrite');
            const store = tx.objectStore(STORE_TULAJDONOS);
            
            const request = tulaj.tkod ? store.put(tulaj) : store.add(tulaj);

            request.onsuccess = () => {
                alert(`Tulajdonos sikeresen ${tulaj.tkod ? 'm√≥dos√≠tva' : 'hozz√°adva'}!`);
                tulajFormReset();
                tulajdonosokFeltolteseDropdownnal();
                tulajdonosokListazasa();
            };
            request.onerror = (e) => {
                alert("Hiba a Tulajdonos ment√©sekor.");
                console.error("Ment√©si hiba:", e);
            };
        }
        
        function tulajdonosModositasElokeszites(tkod) {
            const tx = db.transaction(STORE_TULAJDONOS, 'readonly');
            const store = tx.objectStore(STORE_TULAJDONOS);
            const request = store.get(tkod);

            request.onsuccess = (event) => {
                const tulaj = event.target.result;
                if (tulaj) {
                    document.getElementById('tulaj-tkod-modositando').value = tulaj.tkod;
                    document.getElementById('tulaj-nev').value = tulaj.nev;
                    document.getElementById('tulaj-email').value = tulaj.email;
                    document.getElementById('tulaj-mentes-btn').textContent = 'üìù M√≥dos√≠t√°s Ment√©se';
                }
            };
        }
        
        function tulajdonosTorles(tkod) {
            if (!confirm(`Biztosan t√∂r√∂lni szeretn√© a(z) ${tkod} T.K√≥d√∫ tulajdonost? A hozz√° tartoz√≥ aut√≥k tulajdonosa "Nincs" lesz.`)) return;

            // El≈ësz√∂r m√≥dos√≠tjuk a hozz√° tartoz√≥ aut√≥k tulajTkod mez≈ëj√©t (gyeng√≠tj√ºk a kapcsolatot)
            const txAuto = db.transaction(STORE_AUTO, 'readwrite');
            const autoStore = txAuto.objectStore(STORE_AUTO);
            const index = autoStore.index('tulajTkod');
            const range = IDBKeyRange.only(tkod);
            
            index.openCursor(range).onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const auto = cursor.value;
                    auto.tulajTkod = null; // Vagy egy speci√°lis "Nincs Tulajdonos" kulcs
                    cursor.update(auto);
                    cursor.continue();
                }
            };

            txAuto.oncomplete = () => {
                // Majd t√∂r√∂lj√ºk a Tulajdonost
                const txTulaj = db.transaction(STORE_TULAJDONOS, 'readwrite');
                const tulajStore = txTulaj.objectStore(STORE_TULAJDONOS);
                tulajStore.delete(tkod).onsuccess = () => {
                    alert('Tulajdonos √©s kapcsol√≥d√≥ adatok friss√≠t√©se sikeres.');
                    tulajFormReset();
                    tulajdonosokFeltolteseDropdownnal();
                    tulajdonosokListazasa();
                    autokListazasa(); // Aut√≥ lista friss√≠t√©se is sz√ºks√©ges
                };
            };
            txAuto.onerror = (e) => console.error("Tulajdonos t√∂rl√©si hiba (aut√≥ friss√≠t√©skor):", e);
        }

        function tulajFormReset() {
            document.getElementById('tulajdonos-form').reset();
            document.getElementById('tulaj-tkod-modositando').value = '';
            document.getElementById('tulaj-mentes-btn').textContent = 'üíæ √öj Tulajdonos Ment√©se';
        }

        function tulajdonosokListazasa(oszlop) {
            const tablaBody = document.querySelector('#tulajdonos-tabla tbody');
            const keresoSzo = document.getElementById('tulaj-kereses-nev').value.toLowerCase().trim();
            tablaBody.innerHTML = '<tr><td colspan="4">Bet√∂lt√©s...</td></tr>';
            
            // Rendez√©s be√°ll√≠t√°sa
            if (oszlop) {
                if (tulajRendezesOszlop === oszlop) {
                    rendezesIrany = (rendezesIrany === 'asc' ? 'desc' : 'asc');
                } else {
                    tulajRendezesOszlop = oszlop;
                    rendezesIrany = 'asc';
                }
            }

            const tx = db.transaction(STORE_TULAJDONOS, 'readonly');
            const store = tx.objectStore(STORE_TULAJDONOS);
            
            // Keres√©s n√©v index alapj√°n (ha a keres≈ëszo nem √ºres)
            let index;
            let range;
            if (keresoSzo) {
                // Mivel az IndexedDB csak "start with" (prefix) keres√©st t√°mogat indexen kereszt√ºl hat√©konyan,
                // haszn√°lhatunk `lowerBound` √©s `upperBound`-ot. De mivel a feladat csak "n√©v alapj√°n" keres√©st k√©r,
                // a legegyszer≈±bb, ha csak a list√°z√°s ut√°n sz≈±r√ºnk, ha nem tiszta prefix keres√©sr≈ël van sz√≥.
                // Itt csak sima beolvas√°st haszn√°lok, majd JS-ben sz≈±r√∂k.
                index = store.index('nev');
                // Ha csak a prefixet akarn√°nk, ez lenne: 
                // range = IDBKeyRange.bound(keresoSzo, keresoSzo + '\uffff', false, false);
            }

            const request = index ? index.openCursor(range) : store.openCursor();
            const tulajdonosok = [];

            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const tulaj = cursor.value;
                    // JS oldali keres√©s, ha nem indexelt a mez≈ëre van sz√ºks√©g
                    if (!keresoSzo || tulaj.nev.toLowerCase().includes(keresoSzo)) {
                        tulajdonosok.push(tulaj);
                    }
                    cursor.continue();
                } else {
                    // Rendez√©s √©s megjelen√≠t√©s
                    tulajdonosok.sort((a, b) => {
                        const aVal = String(a[tulajRendezesOszlop]).toLowerCase();
                        const bVal = String(b[tulajRendezesOszlop]).toLowerCase();
                        let osszehasonlitas = aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                        return rendezesIrany === 'asc' ? osszehasonlitas : -osszehasonlitas;
                    });
                    
                    tablaBody.innerHTML = ''; // T√°bl√°zat t√∂rl√©se

                    if (tulajdonosok.length === 0) {
                        tablaBody.innerHTML = '<tr><td colspan="4">Nincs megjelen√≠thet≈ë tulajdonos.</td></tr>';
                        return;
                    }
                    
                    tulajdonosok.forEach(tulaj => {
                        const row = tablaBody.insertRow();
                        row.insertCell(0).textContent = tulaj.tkod;
                        row.insertCell(1).textContent = tulaj.nev;
                        row.insertCell(2).textContent = tulaj.email;
                        
                        const muveletCell = row.insertCell(3);
                        muveletCell.className = 'muvelet-cella';
                        
                        const modositBtn = document.createElement('button');
                        modositBtn.textContent = '‚úèÔ∏è';
                        modositBtn.className = 'edit-btn';
                        modositBtn.onclick = () => tulajdonosModositasElokeszites(tulaj.tkod);
                        
                        const torolBtn = document.createElement('button');
                        torolBtn.textContent = '‚ùå';
                        torolBtn.className = 'delete-btn';
                        torolBtn.onclick = () => tulajdonosTorles(tulaj.tkod);
                        
                        muveletCell.appendChild(modositBtn);
                        muveletCell.appendChild(torolBtn);
                    });
                }
            };
        }
        
        // 3. **Aut√≥ CRUD, Keres√©s √©s Sz≈±r√©s**

        function tulajdonosokFeltolteseDropdownnal() {
            const tulajSelectAuto = document.getElementById('auto-tulajTkod');
            const tulajSelectSzures = document.getElementById('auto-szures-tulaj');
            
            // Megtartjuk az els≈ë (default) opci√≥kat
            tulajSelectAuto.innerHTML = '<option value="">-- V√°lasszon Tulajdonost --</option>';
            tulajSelectSzures.innerHTML = '<option value="">-- √ñsszes Tulajdonos --</option>';

            const tx = db.transaction(STORE_TULAJDONOS, 'readonly');
            const store = tx.objectStore(STORE_TULAJDONOS);
            const request = store.openCursor();
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const tulaj = cursor.value;
                    
                    const optionAuto = new Option(`${tulaj.nev} (T.K√≥d: ${tulaj.tkod})`, tulaj.tkod);
                    tulajSelectAuto.add(optionAuto);
                    
                    const optionSzures = new Option(`${tulaj.nev} (T.K√≥d: ${tulaj.tkod})`, tulaj.tkod);
                    tulajSelectSzures.add(optionSzures);
                    
                    cursor.continue();
                }
            };
        }
        
        document.getElementById('auto-form').onsubmit = (event) => {
            event.preventDefault();
            const rendszam = document.getElementById('auto-rendszam').value.toUpperCase().trim();
            const eredetiRendszam = document.getElementById('auto-eredeti-rendszam').value;
            const tulajTkod = parseInt(document.getElementById('auto-tulajTkod').value);
            const tipus = document.getElementById('auto-tipus').value.trim();
            const szin = document.getElementById('auto-szin').value.trim();
            const evjarat = parseInt(document.getElementById('auto-evjarat').value);
            
            const auto = { rendszam, tulajTkod, tipus, szin, evjarat };

            if (eredetiRendszam && eredetiRendszam !== rendszam) {
                 // Ha m√≥dos√≠t√°s van, √©s megv√°ltozott a kulcs (rendsz√°m)
                 alert("A rendsz√°m m√≥dos√≠t√°sa kulcsmez≈ë cser√©t ig√©nyel. K√©rj√ºk, haszn√°lja a T√∂rl√©s, majd √öj aut√≥ funkci√≥t a kulcs cser√©j√©hez.");
                 return;
            }

            mentesAuto(auto, eredetiRendszam);
        };
        
        function mentesAuto(auto, eredetiRendszam) {
            const tx = db.transaction(STORE_AUTO, 'readwrite');
            const store = tx.objectStore(STORE_AUTO);
            
            const request = eredetiRendszam ? store.put(auto) : store.add(auto); // put = update, add = insert
            
            request.onsuccess = () => {
                alert(`Aut√≥ sikeresen ${eredetiRendszam ? 'm√≥dos√≠tva' : 'hozz√°adva'}!`);
                autoFormReset();
                autokListazasa();
            };
            request.onerror = (e) => {
                if (e.target.error.name === 'ConstraintError') {
                    alert(`Hiba: A ${auto.rendszam} rendsz√°m m√°r l√©tezik.`);
                } else {
                    alert("Hiba az Aut√≥ ment√©sekor.");
                    console.error("Ment√©si hiba:", e);
                }
            };
        }
        
        function autoModositasElokeszites(rendszam) {
            const tx = db.transaction(STORE_AUTO, 'readonly');
            const store = tx.objectStore(STORE_AUTO);
            const request = store.get(rendszam);
            
            request.onsuccess = (event) => {
                const auto = event.target.result;
                if (auto) {
                    document.getElementById('auto-rendszam').value = auto.rendszam;
                    document.getElementById('auto-eredeti-rendszam').value = auto.rendszam; // Ezt haszn√°ljuk ellen≈ërz√©sre
                    document.getElementById('auto-rendszam').readOnly = true; // Rendsz√°mot nem engedj√ºk m√≥dos√≠tani
                    document.getElementById('auto-tulajTkod').value = auto.tulajTkod || ''; 
                    document.getElementById('auto-tipus').value = auto.tipus;
                    document.getElementById('auto-szin').value = auto.szin;
                    document.getElementById('auto-evjarat').value = auto.evjarat;
                    document.getElementById('auto-mentes-btn').textContent = 'üìù M√≥dos√≠t√°s Ment√©se';
                }
            };
        }
        
        function autoTorles(rendszam) {
            if (!confirm(`Biztosan t√∂r√∂lni szeretn√© a(z) ${rendszam} rendsz√°m√∫ aut√≥t?`)) return;

            const tx = db.transaction(STORE_AUTO, 'readwrite');
            const store = tx.objectStore(STORE_AUTO);
            
            store.delete(rendszam).onsuccess = () => {
                alert('Aut√≥ sikeresen t√∂r√∂lve.');
                autokListazasa();
            };
        }
        
        function autoFormReset() {
            document.getElementById('auto-form').reset();
            document.getElementById('auto-eredeti-rendszam').value = '';
            document.getElementById('auto-rendszam').readOnly = false;
            document.getElementById('auto-mentes-btn').textContent = 'üíæ √öj Aut√≥ Ment√©se';
        }

        async function autokListazasa(oszlop) {
            const tablaBody = document.querySelector('#auto-tabla tbody');
            const keresoSzo = document.getElementById('auto-kereses').value.toLowerCase().trim();
            const szuresTulajTkod = document.getElementById('auto-szures-tulaj').value;
            tablaBody.innerHTML = '<tr><td colspan="6">Bet√∂lt√©s...</td></tr>';

            // Rendez√©s be√°ll√≠t√°sa
            if (oszlop) {
                if (autoRendezesOszlop === oszlop) {
                    rendezesIrany = (rendezesIrany === 'asc' ? 'desc' : 'asc');
                } else {
                    autoRendezesOszlop = oszlop;
                    rendezesIrany = 'asc';
                }
            }

            // Tulajdonos nevek el≈ëzetes bet√∂lt√©se
            const tulajdonosokMap = await getAllOwnersMap();

            const tx = db.transaction(STORE_AUTO, 'readonly');
            const store = tx.objectStore(STORE_AUTO);
            const autok = [];

            let index;
            let range;
            
            // Sz≈±r√©s Tulajdonos alapj√°n (Index haszn√°lat√°val)
            if (szuresTulajTkod) {
                index = store.index('tulajTkod');
                range = IDBKeyRange.only(parseInt(szuresTulajTkod));
            } else if (keresoSzo) {
                 // Keres√©s Rendsz√°m, T√≠pus vagy Sz√≠n alapj√°n (Nincs hat√©kony egy Index)
                 // K√©zzel kell iter√°lni az √∂sszes adatot, ha a keres√©s t√∂bb mez≈ëre is vonatkozik
                 // Ehelyett csak sima openCursor()-t haszn√°lunk √©s JS-ben sz≈±r√ºnk
            }
            
            const request = index ? index.openCursor(range) : store.openCursor();

            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const auto = cursor.value;
                    
                    // JS oldali keres√©s (rendsz√°m, t√≠pus, sz√≠n)
                    const keresesTalalat = !keresoSzo || 
                        auto.rendszam.toLowerCase().includes(keresoSzo) ||
                        auto.tipus.toLowerCase().includes(keresoSzo) ||
                        auto.szin.toLowerCase().includes(keresoSzo);
                    
                    if (keresesTalalat) {
                        autok.push(auto);
                    }
                    cursor.continue();
                } else {
                    // Rendez√©s √©s megjelen√≠t√©s
                    autok.sort((a, b) => {
                        const aVal = String(a[autoRendezesOszlop]).toLowerCase();
                        const bVal = String(b[autoRendezesOszlop]).toLowerCase();
                        let osszehasonlitas = aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                        return rendezesIrany === 'asc' ? osszehasonlitas : -osszehasonlitas;
                    });
                    
                    tablaBody.innerHTML = ''; // T√°bl√°zat t√∂rl√©se

                    if (autok.length === 0) {
                        tablaBody.innerHTML = '<tr><td colspan="6">Nincs megjelen√≠thet≈ë aut√≥.</td></tr>';
                        return;
                    }

                    autok.forEach(auto => {
                        const row = tablaBody.insertRow();
                        const tulajNev = tulajdonosokMap[auto.tulajTkod] ? 
                                         `${tulajdonosokMap[auto.tulajTkod].nev} (${auto.tulajTkod})` : 
                                         `Nincs (K√≥d: ${auto.tulajTkod || 'N/A'})`;
                        
                        row.insertCell(0).textContent = auto.rendszam;
                        row.insertCell(1).textContent = auto.tipus;
                        row.insertCell(2).textContent = auto.szin;
                        row.insertCell(3).textContent = auto.evjarat;
                        row.insertCell(4).textContent = tulajNev;
                        
                        const muveletCell = row.insertCell(5);
                        muveletCell.className = 'muvelet-cella';

                        const modositBtn = document.createElement('button');
                        modositBtn.textContent = '‚úèÔ∏è';
                        modositBtn.className = 'edit-btn';
                        modositBtn.onclick = () => autoModositasElokeszites(auto.rendszam);
                        
                        const torolBtn = document.createElement('button');
                        torolBtn.textContent = '‚ùå';
                        torolBtn.className = 'delete-btn';
                        torolBtn.onclick = () => autoTorles(auto.rendszam);
                        
                        muveletCell.appendChild(modositBtn);
                        muveletCell.appendChild(torolBtn);
                    });
                }
            };
        }

        // Seg√©df√ºggv√©ny: Tulajdonosok bet√∂lt√©se a gyors 1:N felold√°shoz
        function getAllOwnersMap() {
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_TULAJDONOS, 'readonly');
                const store = tx.objectStore(STORE_TULAJDONOS);
                const request = store.getAll();
                const map = {};

                request.onsuccess = (event) => {
                    event.target.result.forEach(tulaj => {
                        map[tulaj.tkod] = tulaj;
                    });
                    resolve(map);
                };
                request.onerror = () => resolve({});
            });
        }
        
        // 4. **JSON Export / Import**
        
        async function exportDB() {
            const tulajdonosok = await getStoreData(STORE_TULAJDONOS);
            const autok = await getStoreData(STORE_AUTO);

            const exportData = {
                tulajdonosok: tulajdonosok,
                autok: autok
            };

            const jsonText = JSON.stringify(exportData, null, 2);
            document.getElementById('json-adat').value = jsonText;

            // F√°jlk√©nt let√∂lt√©s
            const blob = new Blob([jsonText], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'IndexedDB_export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Adatb√°zis export√°lva JSON form√°tumban √©s let√∂lt√©s elind√≠tva!');
        }

        function getStoreData(storeName) {
            return new Promise((resolve) => {
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = () => resolve([]);
            });
        }
        
        function importDB() {
            const jsonText = document.getElementById('json-adat').value.trim();
            if (!jsonText) {
                alert('Illesszen be JSON adatot az import√°l√°shoz!');
                return;
            }

            try {
                const importData = JSON.parse(jsonText);
                if (!importData.tulajdonosok || !Array.isArray(importData.tulajdonosok) || 
                    !importData.autok || !Array.isArray(importData.autok)) {
                    throw new Error("Hib√°s JSON strukt√∫ra. 'tulajdonosok' √©s 'autok' t√∂mb√∂kre van sz√ºks√©g.");
                }

                if (!confirm("Biztosan import√°lni szeretn√© az adatokat? Ez fel√ºl√≠rja a megl√©v≈ë IndexedDB adatokat!")) return;

                // T√∂r√∂lj√ºk a megl√©v≈ë adatokat, majd import√°ljuk az √∫jakat
                const tx = db.transaction([STORE_TULAJDONOS, STORE_AUTO], 'readwrite');
                const tulajStore = tx.objectStore(STORE_TULAJDONOS);
                const autoStore = tx.objectStore(STORE_AUTO);

                tulajStore.clear();
                autoStore.clear();

                // Tulajdonosok import√°l√°sa
                importData.tulajdonosok.forEach(tulaj => {
                    // Mivel a tkod autoIncrement, musz√°j a kulcsot megadni a put-tal, 
                    // de vigy√°zni kell a duplik√°ci√≥kkal, ha nem egyedi kulcsot haszn√°lunk.
                    // Itt felt√©telezz√ºk, hogy az export√°lt tkod-ok egyediek.
                    tulajStore.put(tulaj); 
                });

                // Aut√≥k import√°l√°sa
                importData.autok.forEach(auto => {
                    autoStore.put(auto); // Rendsz√°m F≈ë kulcs
                });

                tx.oncomplete = () => {
                    alert('Adatok sikeresen import√°lva! Az adatb√°zis friss√ºlt.');
                    tulajdonosokFeltolteseDropdownnal();
                    tulajdonosokListazasa();
                    autokListazasa();
                    document.getElementById('json-adat').value = '';
                };
                tx.onerror = (e) => {
                    alert("Import√°l√°si hiba t√∂rt√©nt.");
                    console.error("Import hiba:", e);
                };

            } catch (e) {
                alert('Hib√°s JSON form√°tum vagy strukt√∫ra: ' + e.message);
                console.error("JSON Hiba:", e);
            }
        }

        // Ind√≠t√°s
        window.onload = initDB;

    </script>
</body>
</html>